## [П]|[РС]|(РП) Поиск углов

Существует множество локальных особенностей, которые можно отслеживать. Для начала заострим внимание на разъяснении того, что такое особенность. Очевидно, что если выбрать точку на большой пустой стене, то не так уж и легко будет обнаружить её в следующем кадре видеопотока. Если все точки на стене будут одинаковыми или очень похожими, то существует очень малый шанс отследить конкретную точку в последующих кадрах. С другой стороны, выбирая уникальную точку, шанс найти её в последующих кадрах в разы возрастают. На практике должны выбираться уникальные (или почти уникальные) точки или особенности, чтобы максимизировать шансы распознать их в последующих кадрах (Рисунок 10-1).

![Рисунок 10-1 не найден](Images/Pic_10_1.jpg)

Рисунок 10-1. Точки в кругах - это хорошие точки для отслеживания, в то время как точки в прямоугольниках – это наихудший выбор

Теперь вновь вернемся к рассмотрению большой пустой стены с точками; можно попытаться найти точки, претерпевающие существенные изменения - например, те, которые имеют сильную производную. На самом деле этого не достаточно, но это только начало. Точка с сильной производной может быть связана с каким-то краем, при этом выглядеть так же, как и все другие точки вдоль этого края (раздел *Метод Lucas-Kanade*, рисунок 10-8).

Если сильная производная наблюдается в двух ортогональных направлениях, то можно надеяться на то, что точка является уникальной. По этой причине зачастую отслеживают так называемую *угловую* особенность. По идее, углы – а не края – это точки, которые содержат достаточно информации, чтобы их можно было бы отслеживать от кадра к кадру. 

Наиболее часто используемое определение угла было представлено *Harris*. Данное определение опирается на матрицу производных интенсивности второго порядка ![Формула 10-1 не найдена](Images/Frml_10_1.jpg). Производные второго порядка, взятые во всех точках изображения, можно представить, как формирование новых "вторых производных изображений" или как объединение в новое изображение *Hessian*. Эта терминология возникла из матрицы *Hessian* вокруг точки, определенной в двух измерениях:

![Формула 10-2 не найдена](Images/Frml_10_2.jpg)

Для угла Harris рассматривается *автокорреляционная матрица* вторых производных изображений по малой области вокруг каждой точки. Такая матрица определяется следующим образом:

![Формула 10-3 не найдена](Images/Frml_10_3.jpg)

где ![Формула 10-4 не найдена](Images/Frml_10_4.jpg) – весовой вклад, который может быть постоянным, но зачастую используется для создания кругового окна или Гауссова взвешивания. Углы по определению Harris это места на изображении, где автокорреляционная матрица вторых производных имеет два больших собственных значения. В сущности, это означает, что текстура (или края) проходят, по крайней мере, два отдельных направления, центрируемых вокруг такой точки, которая соответствует реальному углу, имеющего два ребра, встречающихся в точке. Вторые производные полезны, т.к. они не зависят от однородного градиента. (Градиент получается из первых производных. Если первые производные являются однородными (константами), то вторая производная равна 0). Это определение также полезно в случае рассмотрения только собственных значений автокорреляционной матрицы, т.к. в таком случае рассматриваются значения, которые инвариантны к вращению, что очень важно, потому что отслеживаемые объекты могут вращаться и перемещаться. В добавок к этому, эти два собственных числа определяют не только является ли выбранная особенность хорошей для отслеживания, но и обеспечивают идентификационную подпись для точки.

В исходное определение Harris включено взятие детерминанта H(p), с вычетом из него следа H(p) (с некоторым весовым коэффициентом) и последующим сравнением полученной разницы с заданным порогом. Впоследствии, *Shi* и *Tomasi* обнаружили, что хорошие углы можно получить, если наименьшее из собственных чисел больше минимального порога. Метод *Shi* и *Tomasi* является не только самодостаточным, но и во многих случаях дает более хорошие результаты, чем метод Harris.

Функция *cvGoodFeaturesToTrack()* реализует метод *Shi* и *Tomasi*. Эта функция вычисляет вторые производные (с помощью оператора Собеля), которые необходимы для вычисления собственных чисел. В результате функция возвращает список точек, которые соответствуют определению хороших точек для отслеживания.

```cpp
void cvGoodFeaturesToTrack(
     const CvArr*   image
    ,CvArr*         eigImage
    ,CvArr*         tempImage
    ,CvPoint2D32f*  corners
    ,int*           corner_count
    ,double         quality_level
    ,double         min_distance
    ,const CvArr*   mask        = NULL
    ,int            block_size  = 3
    ,int            use_harris  = 0
    ,double         k           = 0.4
);
```

*image* - это исходное 8 или 32 битное (т.е. *IPL_DEPTH_8U* или *IPL_DEPTH_32F*) одноканальное изображение. Следующие два аргумента – это одноканальные 32 битные изображения одинакового размера. И *tempImage* и *eigImage* используются алгоритмом в качестве отправной точки, однако, содержимое *eigImage* имеет смысл. В частности, каждая запись содержит минимальное собственное значение соответствующей точки исходного изображения. *corners* - это массив 32-битных точек (*CvPoint2D32f*), который содержит точки, полученные в результате выполнения алгоритма; память под массив должна быть выделена до вызова функции. При этом естественно объем выделяемой памяти ограничен. *corner_count* указывает на максимальное количество точек. В конечном итоге этот параметр на выходе будет содержать число точек, действительно найденных. Параметр *quality_level* указывает минимально возможное собственное значение для точки, которая будет помечена как угол. Фактически минимальное собственное значение, используемое для сокращения, является продуктом *quality_level* и самого маленького собственного значения, наблюдаемого в изображении. Следовательно, *quality_level* не должен превышать 1 (как правило, это значения равно 0.10 или 0.01). Как только выбраны кандидаты, дальнейший отбор осуществляется таким образом, чтобы точки в пределах небольшой области не были включены в результаты. В частности, *min_distance* гарантирует, что в решении не будут присутствовать две точки с указанным количеством пикселей.

Дополнительный параметр *mask* - это изображение, которое содержит 0 и 1, указывающие на то, какие точки должны рассматриваться как углы, а какие нет. Если данный параметр установлен в NULL, то маска не используется. Аргумент *block_size* задает размер области вокруг пикселя при вычислении автокорреляционной матрицы производных. Как оказалось, лучше всего производить вычисления производных с использованием небольшого окна, нежели производить вычисления лишь в одной точки (т.е. при *block_size = 1*). Если *use_harris != 0*, то определяются углы Harris, а не Shi-Tomasi. Если *use_harris != 0*, то значение *k* - это весовой коэффициент, используемый для установки относительного веса данного следа автокорреляционной матрицы Hessian, сравниваемого с детерминантом той же матрицы.

Результат вызова функции *cvGoodFeaturesToTrack()* - это массив местоположений пикселей, которые необходимо найти на другом подобном изображении. В контексте данной главы интерес вызывает поиск в последующих кадрах видео. Представленный метод может быть использован при попытке связать набор изображений одного и того же изображения, взятого с разных ракурсов. Данная проблема будет более подробно представлена при рассмотрении темы стереозрения.

