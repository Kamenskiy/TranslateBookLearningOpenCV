## [П]|[РС]|(РП) Градиенты и производная Собеля

Вычисление производных (или их аппроксимации) - это одна из наиболее важных базовых сверток. Есть множество способов сделать это, но далеко не все из них хорошо подходят для конкретной ситуации. 

В общем, самым распространенным оператором, используемый для представления дифференцирования, является производная Собеля (рисунок 6-3 и 6-4). Существуют операторы Собеля для любого порядка производной, а также для смешанных частных производных (![Формула 6-10 не найдена](Images/Frml_6_10.jpg)).

![Рисунок 6-3 не найден](Images/Pic_6_3.jpg)

Рисунок 6-3. Результат применения оператора Собеля, используемый для аппроксимации производной по оси x

![Рисунок 6-4 не найден](Images/Pic_6_4.jpg)

Рисунок 6-4. Результат применения оператора Собеля, используемый для аппроксимации производной по оси y

```cpp
cvSobel(
     const CvArr*   src
    ,CvArr*         dst
    ,int            xorder
    ,int            yorder
    ,int            aperture_size = 3
);
```

Аргументы *src* и *dst* - исходное и конечное изображения, а аргументы *xorder* и *yorder* - порядки производной. Обычно используется 0, 1 или максимум 2 производная; значение 0 означает, что производная в указанном направлении браться не будет (при этом хотя бы одно из направлений должно быть не нулевым). Аргумент *aperture_size* должен быть нечетным числом и задавать ширину (и высоту) квадратного фильтра. На момент написания книги поддерживаемые размеры апертуры 1, 3, 5 и 7. Если исходное изображение 8-битное, тогда конечное изображение должно быть глубиной *IPL_DEPTH_16S*, чтобы избежать переполнения.

Производные Собеля обладают хорошим свойством в том смысле, что могут быть определены для ядер любого размера, которые в свою очередь могут быть быстро построены. Более крупные ядра дают лучшую аппроксимацию производной, потому что мелкие ядра очень чувствительны к шуму. 

Что бы это осознать, нужно понимать, что производная Собеля в действительности производной не является. Это все потому, что оператор Собеля определен в дискретном пространстве. Что в действительности представляет собой оператор Собеля, так это подгонку под полином. Так что, производная Собеля второго порядка по оси x на самом деле не вторая производная, а локальная подгонка под параболическую функцию. Это объясняет необходимость использования ядра большего размера, т.к. большое ядро производит подгонку над большим количеством пикселей. 


### Фильтр Щарра

В действительности существует множество способов аппроксимировать производную для случая дискретной сетки. Недостатком аппроксимации с использованием оператора Собеля является то, что она менее точна для маленьких ядер. Для больших ядер, где используется больше точек для аппроксимации, эта проблема менее значительна. Эти неточности не видны для X и Y фильтров, используемые в *cvSobel()*, потому что они точно совпадают с осями *x* и *y*. Трудности появляются при проведении замеров по изображению с использованием аппроксимации производной по направлению (например, по направлению градиента изображения путем использования результата фильтра по арктангенсу *y/x*). 

Чтобы прояснить смысл, рассмотрим реальный пример замера изображения такого вида - процесс получения информации о форме объекта путем сбора гистограммы градиентных углов вокруг объекта. Подобные гистограммы - это выходные данные и основа для множества обычных классификаторов форм (как для их обучения, так и для работы). В этом случае, неточные измерения угла наклона снизит производительность распознавания классификатора.

Для фильтра Собеля размером 3x3 неточность возрастает с увеличением градиентного угла по горизонтали или вертикали. OpenCV заботится о маленьких (но быстро растущих) неточностях фильтров Собеля размером 3x3 при помощи "закулисных" дополнений внутри функции *cvSobel()* за счет использования значения *CV_SCHARR* для аргумента *apperture_size*. Фильтр Щарра так же быстр, но более точен, чем фильтр Собеля, поэтому именно фильтр Щарра должен быть использован для измерений изображений с фильтром размера 3x3. Коэффициенты Щарра показаны на рисунке 6-5. 

![Рисунок 6-5 не найден](Images/Pic_6_5.jpg)

Рисунок 6-5. Фильтр Щарра размером 3x3 с использованием флага CV_SCHARR

